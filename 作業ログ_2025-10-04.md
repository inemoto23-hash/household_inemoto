# 家計簿アプリ作業ログ - 2025年10月4日

## 完了した作業

### 1. レシート解析機能の削除とあいまい登録機能への置き換え
- ✅ レシート解析機能を完全削除
- ✅ あいまい登録機能を実装（自然言語入力でOpenAI GPT-4o-mini使用）
- ✅ 必須項目チェック機能を追加
- ✅ 日本時間(UTC+9)対応

**実装内容:**
- `public/index.html`: レシートタブをあいまい登録タブに変更
- `public/js/fuzzy-register.js`: 新規作成
- `public/css/style.css`: あいまい登録用スタイル追加
- `server.js`: `/api/parse-fuzzy` エンドポイント追加
- `public/js/app.js`: レシート関連の全関数・イベントリスナーを削除

**あいまい登録の使い方:**
```
例: 「ファミマで昼ごはん買った、368円、楽天Payたけで払った」
例: 「昨日ファミマで昼ごはん買った、368円」
例: 「10月3日にヤオコーで買い物、2500円、クレジットカードで」
```

### 2. Railway PostgreSQL対応
- ✅ PostgreSQLアドオン追加
- ✅ DATABASE_URL環境変数設定
- ✅ 初期データ275件を投入

**デプロイURL:**
- https://householdinemoto-production.up.railway.app

**データベース状態:**
```json
{
  "type": "postgresql",
  "connected": true,
  "transactionCount": "275",
  "categoryCount": "12"
}
```

### 3. PostgreSQL互換性修正

#### 修正1: SQL日付関数の変換
SQLite固有の関数をPostgreSQL互換に変換:
- `strftime('%Y-%m', date)` → `TO_CHAR(date, 'YYYY-MM')` (PostgreSQL) / `strftime('%Y-%m', date)` (SQLite)
- `strftime('%Y', date)` → `EXTRACT(YEAR FROM date)::text`
- `strftime('%m', date)` → `LPAD(EXTRACT(MONTH FROM date)::text, 2, '0')`
- `date(column)` → `column::date`

**ヘルパー関数追加 (server.js):**
```javascript
function getYearMonthFormat(columnName)
function getYearFormat(columnName)
function getMonthFormat(columnName)
function getDateOnly(columnName)
```

#### 修正2: パラメータバインディング
- SQLite: `?`, `?`, `?`
- PostgreSQL: `$1`, `$2`, `$3`

条件分岐で適切なプレースホルダーを使用:
```javascript
WHERE column = ${db.type === 'postgresql' ? '$1' : '?'}
```

#### 修正3: 外部キー制約
PostgreSQLでは`ADD CONSTRAINT IF NOT EXISTS`が使えないため:
```javascript
// 修正前（エラー）
ALTER TABLE transactions ADD CONSTRAINT IF NOT EXISTS fk_name ...

// 修正後（OK）
const exists = await db.get(
  `SELECT constraint_name FROM information_schema.table_constraints
   WHERE constraint_name = $1`,
  [fk.name]
);
if (!exists) {
  await db.run(fk.sql);
}
```

### 4. データベース初期化API追加
- `GET /api/database/status`: データベース状態確認
- `POST /api/database/init`: 手動で初期データ投入

## 現在の問題点

### まだ残っている可能性のあるエラー
最後のログでは以下のエラーが出ていた:
1. `syntax error at or near "NOT"` - 外部キー制約（修正済み、次回デプロイで確認）
2. 金額表示が一部おかしい（詳細不明）

## 次回の作業予定

### 1. PostgreSQLエラーの完全解消
- [ ] 最新のデプロイログを確認
- [ ] 残っているSQL構文エラーを特定・修正
- [ ] 金額表示の不具合を調査・修正

### 2. 動作確認
- [ ] カレンダー表示の確認
- [ ] 集計機能の確認
- [ ] 統計・グラフ機能の確認
- [ ] あいまい登録機能のテスト
- [ ] 全機能の動作確認

### 3. 追加機能（必要に応じて）
- [ ] バックアップ・リストア機能のテスト
- [ ] エラーハンドリングの改善
- [ ] パフォーマンス最適化

## 技術的な参考情報

### 環境変数設定（Railway）
```env
DATABASE_URL=postgresql://...（自動設定）
OPENAI_API_KEY=sk-...
NODE_ENV=production
```

### ローカル開発環境
```bash
cd "C:\Users\inemo\Desktop\家計簿アプリ"
npm start
# http://localhost:3000
```

### データベース
- **ローカル**: SQLite (`database/household_budget.db`)
- **Railway**: PostgreSQL (自動切り替え)

### Git リポジトリ
- https://github.com/inemoto23-hash/household_inemoto

### 最近のコミット
1. `10289cd` - PostgreSQL外部キー制約のエラー修正
2. `5a5794b` - PostgreSQLパラメータバインディング修正
3. `0d6d6d6` - PostgreSQL対応: SQLite固有の関数をクロスDB互換に修正
4. `d1cdfdf` - データベース初期化APIを追加
5. `1ba082b` - あいまい登録の日付処理を日本時間(UTC+9)に対応
6. `da29254` - レシート解析機能の完全削除とあいまい登録機能への移行

## 重要なファイル

### フロントエンド
- `public/index.html` - メインHTML
- `public/js/app.js` - メインロジック
- `public/js/fuzzy-register.js` - あいまい登録機能
- `public/css/style.css` - スタイル

### バックエンド
- `server.js` - Express サーバー
- `database/database.js` - DB接続ラッパー
- `database/seed.js` - シードデータ（275件の取引）

### 設定
- `.env` - 環境変数（ローカル）
- `package.json` - 依存パッケージ

## トラブルシューティング

### PostgreSQLエラーが出る場合
1. Railwayのデプロイログを確認
2. エラーメッセージから問題のSQL文を特定
3. `server.js`の該当箇所を修正
4. コミット・プッシュして再デプロイ

### ローカルでテストする場合
```bash
# SQLiteで動作確認
cd "C:\Users\inemo\Desktop\家計簿アプリ"
npm start
```

### データベースをリセットする場合（Railway）
```bash
# 既存データを削除して再初期化
curl -X POST https://householdinemoto-production.up.railway.app/api/database/init
```

## メモ
- Railwayは自動デプロイ（GitHubプッシュ時）
- PostgreSQLは永続化されるため、再起動でもデータは消えない
- ログの量が多い場合は、Railwayの制限（500ログ/秒）に注意
